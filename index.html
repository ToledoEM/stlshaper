<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>STLShaper - STL Deformation Tool</title>
        <style>
            body {
                margin: 0;
                background: #262626;
                color: #ccc;
                font-family: Arial;
                position: relative;
                height: 100vh;
                overflow: hidden;
            }

            #ui {
                position: absolute;
                top: 10px;
                left: 10px;
                background: #222;
                padding: 15px;
                border-radius: 4px;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                gap: 10px;
                width: 250px;
                max-height: calc(100vh - 20px);
                overflow-y: auto;
                overscroll-behavior: contain;
            }

            #ui > * {
                width: 100%;
                box-sizing: border-box;
            }

            #ui input[type="file"] {
                margin-bottom: 5px;
            }

            #ui label {
                display: block;
                margin: 3px 0;
                cursor: pointer;
                font-size: 0.9em;
            }

            .deform-controls {
                background: #333;
                padding: 8px;
                border-radius: 3px;
                margin: 5px 0;
            }

            .deform-controls label {
                font-size: 0.85em;
            }

            .deform-controls input[type="range"] {
                width: 100%;
                margin: 3px 0;
            }

            .deform-controls select {
                width: 100%;
                padding: 4px;
                background: #444;
                color: #ccc;
                border: 1px solid #555;
                border-radius: 3px;
            }

            .deform-controls span {
                float: right;
                color: #6cf;
                font-weight: bold;
            }

            #status {
                height: 70px;
                line-height: 14px;
                padding: 5px;
                background: #444;
                border-radius: 3px;
                text-align: center;
                font-size: 0.9em;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #progressContainer {
                display: none;
            }

            #progressBar {
                width: 100%;
                height: 8px;
                background: #333;
                border-radius: 4px;
                overflow: hidden;
            }

            #progressFill {
                height: 100%;
                background: #6cf;
                width: 0%;
                transition: width 0.3s ease;
            }

            button {
                padding: 8px;
                background: #555;
                color: #fff;
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }

            button:hover:not(:disabled) {
                background: #666;
            }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            #container {
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 1;
            }

            #stats {
                padding: 6px;
                background: #333;
                border-radius: 3px;
                font-size: 0.8em;
                color: #bbb;
                line-height: 1.3em;
            }
        </style>
    </head>
    <body>
        <div id="ui">
            <div id="status">Ready to load STL.</div>

            <div id="progressContainer" style="display: none;">
                <div
                    id="progressBar"
                    style="
                        width: 100%;
                        height: 8px;
                        background: #333;
                        border-radius: 4px;
                        overflow: hidden;
                    "
                >
                    <div
                        id="progressFill"
                        style="
                            height: 100%;
                            background: #6cf;
                            width: 0%;
                            transition: width 0.3s ease;
                        "
                    ></div>
                </div>
            </div>

            <input type="file" id="fileInput" accept=".stl" />

            <div>
                <strong>Deformation Type:</strong>
                <label
                    ><input type="radio" name="type" value="noise" checked />
                    Noise</label
                >
                <label
                    ><input type="radio" name="type" value="sine" /> Sine
                    Wave</label
                >
                <label
                    ><input type="radio" name="type" value="pixel" />
                    Pixelate</label
                >
                <label
                    ><input type="radio" name="type" value="idw" />
                    IDW Shepard</label
                >
                <label
                    ><input type="radio" name="type" value="inflate" />
                    Inflate</label
                >
                <label
                    ><input type="radio" name="type" value="twist" />
                    Twist</label
                >
                <label
                    ><input type="radio" name="type" value="bend" />
                    Bend</label
                >
                <label
                    ><input type="radio" name="type" value="ripple" />
                    Ripple</label
                >
                <label
                    ><input type="radio" name="type" value="warp" />
                    Warp</label
                >
                <label
                    ><input type="radio" name="type" value="hyper" />
                    Hyperbolic Stretch</label
                >
                <label
                    ><input type="radio" name="type" value="tessellate" />
                    Tessellate</label
                >
                <label
                    ><input type="radio" name="type" value="boundary" />
                    Boundary Disruption</label
                >
                <label
                    ><input type="radio" name="type" value="menger" />
                    Menger Sponge</label
                >
            </div>

            <div id="noiseControls" class="deform-controls">
                <strong>Noise Settings:</strong>
                <label>
                    Intensity: <span id="noiseIntensityVal">1.5</span>
                    <input
                        type="range"
                        id="noiseIntensity"
                        min="0.1"
                        max="5"
                        value="1.5"
                        step="0.1"
                    />
                </label>
                <label>
                    Scale: <span id="noiseScaleVal">0.02</span>
                    <input
                        type="range"
                        id="noiseScale"
                        min="0.005"
                        max="0.5"
                        value="0.02"
                        step="0.005"
                    />
                </label>
                <label>
                    Axis:
                    <select id="noiseAxis">
                        <option value="all">All Axes</option>
                        <option value="x">X Only</option>
                        <option value="y">Y Only</option>
                        <option value="z">Z Only</option>
                        <option value="xy">X & Y</option>
                        <option value="xz">X & Z</option>
                        <option value="yz">Y & Z</option>
                    </select>
                </label>
            </div>

            <div
                id="sineControls"
                class="deform-controls"
                style="display: none"
            >
                <strong>Sine Wave Settings:</strong>
                <label>
                    Amplitude: <span id="sineAmpVal">15</span>
                    <input
                        type="range"
                        id="sineAmp"
                        min="1"
                        max="100"
                        value="15"
                        step="1"
                    />
                </label>
                <label>
                    Frequency: <span id="sineFreqVal">0.05</span>
                    <input
                        type="range"
                        id="sineFreq"
                        min="0.01"
                        max="0.2"
                        value="0.05"
                        step="0.01"
                    />
                </label>
                <label>
                    Driver Axis (input):
                    <select id="sineDriverAxis">
                        <option value="x">X Axis</option>
                        <option value="y">Y Axis</option>
                        <option value="z">Z Axis</option>
                    </select>
                </label>
                <label>
                    Displacement Axis (output):
                    <select id="sineDispAxis">
                        <option value="x">X Only</option>
                        <option value="y">Y Only</option>
                        <option value="z">Z Only</option>
                        <option value="xy">X & Y</option>
                        <option value="xz">X & Z</option>
                        <option value="yz">Y & Z</option>
                        <option value="all">All Axes</option>
                    </select>
                </label>
            </div>

            <div
                id="pixelControls"
                class="deform-controls"
                style="display: none"
            >
                <strong>Pixelate Settings:</strong>
                <label>
                    Voxel Size: <span id="pixelSizeVal">5</span>
                    <input
                        type="range"
                        id="pixelSize"
                        min="0.5"
                        max="50"
                        value="5"
                        step="0.5"
                    />
                </label>
                <label>
                    Axis Lock:
                    <select id="pixelAxis">
                        <option value="all">All Axes</option>
                        <option value="x">X Only</option>
                        <option value="y">Y Only</option>
                        <option value="z">Z Only</option>
                        <option value="xy">X & Y</option>
                        <option value="xz">X & Z</option>
                        <option value="yz">Y & Z</option>
                    </select>
                </label>
            </div>

            <div
                id="idwControls"
                class="deform-controls"
                style="display: none"
            >
                <strong>IDW Shepard Settings:</strong>
                <label>
                    Number of Points: <span id="idwNumPointsVal">8</span>
                    <input
                        type="range"
                        id="idwNumPoints"
                        min="3"
                        max="50"
                        value="8"
                        step="1"
                    />
                </label>
                <label>
                    Seed: <span id="idwSeedVal">0</span>
                    <input
                        type="number"
                        id="idwSeed"
                        min="0"
                        max="10000"
                        value="0"
                        step="1"
                    />
                </label>
                <label>
                    Weight: <span id="idwWeightVal">2.0</span>
                    <input
                        type="range"
                        id="idwWeight"
                        min="-10"
                        max="10"
                        value="2.0"
                        step="0.1"
                    />
                </label>
                <label>
                    Power: <span id="idwPowerVal">2.0</span>
                    <input
                        type="range"
                        id="idwPower"
                        min="0.5"
                        max="6.0"
                        value="2.0"
                        step="0.1"
                    />
                </label>
                <label>
                    Global Scale: <span id="idwScaleVal">2.0</span>
                    <input
                        type="range"
                        id="idwScale"
                        min="0.1"
                        max="10.0"
                        value="2.0"
                        step="0.1"
                    />
                </label>
                <label>
                    Sampling Rays: <span id="idwRaysVal">6</span>
                    <input
                        type="range"
                        id="idwRays"
                        min="2"
                        max="10"
                        value="6"
                        step="1"
                    />
                </label>
                <label>
                    Manual Control Points:
                    <input type="checkbox" id="idwManualPoints" />
                </label>
                <label>
                    Points (x,y,z per line):
                    <textarea id="idwPointsInput" rows="4" style="width:100%; background:#222; color:#ccc; border:1px solid #555; border-radius:3px;"></textarea>
                </label>
            </div>

            <div
                id="inflateControls"
                class="deform-controls"
                style="display: none"
            >
                <strong>Inflate Settings:</strong>
                <label>
                    Amount: <span id="inflateAmountVal">0.6</span>
                    <input
                        type="range"
                        id="inflateAmount"
                        min="0"
                        max="2"
                        value="0.6"
                        step="0.05"
                    />
                </label>
            </div>

            <div
                id="twistControls"
                class="deform-controls"
                style="display: none"
            >
                <strong>Twist Settings:</strong>
                <label>
                    Angle (deg): <span id="twistAngleVal">180</span>
                    <input
                        type="range"
                        id="twistAngle"
                        min="-360"
                        max="360"
                        value="180"
                        step="5"
                    />
                </label>
                <label>
                    Axis:
                    <select id="twistAxis">
                        <option value="y">Y Axis</option>
                        <option value="x">X Axis</option>
                        <option value="z">Z Axis</option>
                    </select>
                </label>
            </div>

            <div
                id="bendControls"
                class="deform-controls"
                style="display: none"
            >
                <strong>Bend Settings:</strong>
                <label>
                    Strength: <span id="bendStrengthVal">0.8</span>
                    <input
                        type="range"
                        id="bendStrength"
                        min="0"
                        max="2"
                        value="0.8"
                        step="0.05"
                    />
                </label>
                <label>
                    Axis:
                    <select id="bendAxis">
                        <option value="x">X Axis</option>
                        <option value="y" selected>Y Axis</option>
                        <option value="z">Z Axis</option>
                    </select>
                </label>
            </div>

            <div
                id="rippleControls"
                class="deform-controls"
                style="display: none"
            >
                <strong>Ripple Settings:</strong>
                <label>
                    Amplitude: <span id="rippleAmpVal">4</span>
                    <input
                        type="range"
                        id="rippleAmp"
                        min="0"
                        max="20"
                        value="4"
                        step="0.5"
                    />
                </label>
                <label>
                    Frequency: <span id="rippleFreqVal">0.3</span>
                    <input
                        type="range"
                        id="rippleFreq"
                        min="0.05"
                        max="2.0"
                        value="0.3"
                        step="0.05"
                    />
                </label>
                <label>
                    Axis:
                    <select id="rippleAxis">
                        <option value="y">Y Axis</option>
                        <option value="x">X Axis</option>
                        <option value="z">Z Axis</option>
                    </select>
                </label>
            </div>

            <div
                id="warpControls"
                class="deform-controls"
                style="display: none"
            >
                <strong>Warp Settings:</strong>
                <label>
                    Strength: <span id="warpStrengthVal">1.0</span>
                    <input
                        type="range"
                        id="warpStrength"
                        min="0"
                        max="3"
                        value="1.0"
                        step="0.1"
                    />
                </label>
                <label>
                    Scale: <span id="warpScaleVal">0.2</span>
                    <input
                        type="range"
                        id="warpScale"
                        min="0.01"
                        max="1.0"
                        value="0.2"
                        step="0.01"
                    />
                </label>
            </div>

            <div
                id="hyperControls"
                class="deform-controls"
                style="display: none"
            >
                <strong>Hyperbolic Stretch Settings:</strong>
                <label>
                    Amount: <span id="hyperAmountVal">0.6</span>
                    <input
                        type="range"
                        id="hyperAmount"
                        min="-2"
                        max="2"
                        value="0.6"
                        step="0.05"
                    />
                </label>
                <label>
                    Axis:
                    <select id="hyperAxis">
                        <option value="y">Y Axis</option>
                        <option value="x">X Axis</option>
                        <option value="z">Z Axis</option>
                    </select>
                </label>
            </div>

            <div
                id="tessellateControls"
                class="deform-controls"
                style="display: none"
            >
                <strong>Tessellation Settings:</strong>
                <label>
                    Subdivisions: <span id="tessellateStepsVal">1</span>
                    <input
                        type="range"
                        id="tessellateSteps"
                        min="1"
                        max="2"
                        value="1"
                        step="1"
                    />
                </label>
            </div>

            <div
                id="boundaryControls"
                class="deform-controls"
                style="display: none"
            >
                <strong>Boundary Disruption Settings:</strong>
                <label>
                    Threshold: <span id="boundaryThresholdVal">0.08</span>
                    <input
                        type="range"
                        id="boundaryThreshold"
                        min="0.01"
                        max="0.3"
                        value="0.08"
                        step="0.01"
                    />
                </label>
                <label>
                    Jitter: <span id="boundaryJitterVal">2</span>
                    <input
                        type="range"
                        id="boundaryJitter"
                        min="0"
                        max="10"
                        value="2"
                        step="0.5"
                    />
                </label>
            </div>

            <div
                id="mengerControls"
                class="deform-controls"
                style="display: none"
            >
                <strong>Menger Sponge Settings:</strong>
                <label>
                    Iterations: <span id="mengerIterationsVal">1</span>
                    <input
                        type="range"
                        id="mengerIterations"
                        min="1"
                        max="3"
                        value="1"
                        step="1"
                    />
                </label>
                <label>
                    Keep Ratio: <span id="mengerKeepVal">0.7</span>
                    <input
                        type="range"
                        id="mengerKeep"
                        min="0.3"
                        max="1.0"
                        value="0.7"
                        step="0.05"
                    />
                </label>
            </div>

            <div class="deform-controls">
                <strong>Preprocess:</strong>
                <label>
                    Decimate (% kept): <span id="decimateVal">100</span>
                    <input
                        type="range"
                        id="decimate"
                        min="10"
                        max="100"
                        value="100"
                        step="5"
                    />
                </label>
                <label>
                    Vertex Merge Epsilon: <span id="mergeVal">0.0</span>
                    <input
                        type="range"
                        id="mergeEpsilon"
                        min="0"
                        max="2"
                        value="0"
                        step="0.05"
                    />
                </label>
            </div>

            <div style="display:flex; gap:8px; align-items:center;">
                <button id="processBtn" disabled style="flex:1;">Generate Deformation</button>
                <button id="clearBtn" style="flex:0 0 auto;">Clear</button>
            </div>

            <div>
                <strong>View Mode:</strong>
                <label
                    ><input type="checkbox" id="toggleView" checked /> Show
                    Deformed Model</label
                >
                <label>
                    Render Mode:
                    <select id="renderMode">
                        <option value="wireframe">Wireframe</option>
                        <option value="solid" selected>Solid 3D</option>
                        <option value="both">Wireframe + Solid</option>
                    </select>
                </label>
                <button id="resetViewBtn" style="margin-top:6px;">Reset View</button>
            </div>

            <button id="exportBtn" disabled>Export Current STL</button>

            <button id="exportSettingsBtn" disabled>Export Settings</button>

            <div id="stats">Stats: N/A</div>

            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #555; text-align: center; font-size: 0.8em; color: #888;">
                STLShaper <a href="https://toledoem.github.io/" target="_blank" style="color: #6cf; text-decoration: none;">ToledoEM</a>, MIT license
                <br />
                <a href="https://toledoem.github.io/stlshaper.html" target="_blank" style="color: #6cf; text-decoration: none;">Documentation</a>
            </div>
        </div>

        <div id="container"></div>

        <script type="module">
            import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.121.1/build/three.module.js";
            import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.121.1/examples/jsm/controls/OrbitControls.js";
            import { STLLoader } from "https://cdn.jsdelivr.net/npm/three@0.121.1/examples/jsm/loaders/STLLoader.js";

            window.THREE = THREE;
            window.OrbitControls = OrbitControls;
            window.STLLoader = STLLoader;

            const loadScript = (src) =>
                new Promise((resolve, reject) => {
                    const script = document.createElement("script");
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.body.appendChild(script);
                });

            await loadScript("libraries/FileSaver.min.js");
            await loadScript("main.js");
        </script>
    </body>
</html>
